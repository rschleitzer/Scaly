# Scaly Codegen Migration: OpenJade → OpenJade/Dazzle Compatible

## Summary

Migrated from OpenJade-only `.dsl` format to dual-compatible `.xml` format that works with both OpenJade and Dazzle.

## Changes

### Template Wrapper

**Before:** `scaly.dsl` (OpenJade-only)
```sgml
<!DOCTYPE STYLE-SHEET PUBLIC "-//James Clark//DTD DSSSL Style Sheet//EN" [
<!ENTITY syntax     SYSTEM "syntax.scm"     >
<!ENTITY parser     SYSTEM "parser.scm"    >
<!ENTITY rules      SYSTEM "rules.scm"      >
<!ENTITY helpers    SYSTEM "helpers.scm"    >
<!ENTITY fodeclare  SYSTEM "fodeclare.scm"  >
]>
<STYLE-SPECIFICATION>
&syntax;
&parser;
&rules;
&helpers;
&fodeclare;
</STYLE-SPECIFICATION>
```

**After:** `grammar.xml` (OpenJade + Dazzle compatible)
```xml
<?xml version="1.0"?>
<!DOCTYPE style-sheet PUBLIC "-//James Clark//DTD DSSSL Style Sheet//EN" [
<!ENTITY fodeclare  SYSTEM "fodeclare.scm"  >
<!ENTITY helpers    SYSTEM "helpers.scm"    >
<!ENTITY syntax     SYSTEM "syntax.scm"     >
<!ENTITY parser     SYSTEM "parser.scm"     >
<!ENTITY rules      SYSTEM "rules.scm"      >
]>
<style-sheet>
<style-specification>
&fodeclare;
&helpers;
&syntax;
&parser;
&rules;
</style-specification>
</style-sheet>
```

**Key differences:**
1. ✅ Added XML declaration: `<?xml version="1.0"?>`
2. ✅ Changed to lowercase `style-sheet` DOCTYPE (proper DSSSL format)
3. ✅ Kept PUBLIC identifier (OpenJade needs DSSSL DTD reference)
4. ✅ Added `<style-sheet>` wrapper element
5. ✅ Changed to lowercase `<style-specification>` (nested inside style-sheet)
6. ✅ Kept entity references (both parsers support)
7. ⚠️  Reordered entities (fodeclare first for proper initialization)

### Scheme Modules (.scm files)

**No changes required!** All `.scm` files remain identical:
- `fodeclare.scm` - Flow object declarations
- `helpers.scm` - Utility functions
- `syntax.scm` - Syntax tree generation
- `parser.scm` - Parser generation
- `rules.scm` - Processing rules

## Command Line Usage

### OpenJade (current)

```bash
openjade -t sgml -d grammar.xml scaly.sgm
```

### Dazzle (when available)

```bash
dazzle -d grammar.xml scaly.sgm
```

**Note:** Both commands produce identical output.

## Compatibility

| Feature | OpenJade | Dazzle |
|---------|----------|--------|
| XML declaration | ✅ Ignored (optional in SGML) | ✅ Required |
| `<!DOCTYPE STYLE-SPECIFICATION>` | ✅ Valid SGML | ✅ Valid XML |
| `<STYLE-SPECIFICATION>` element | ✅ Required by DSSSL | ✅ Recognized |
| Entity references (`&entity;`) | ✅ OpenSP resolves | ✅ libxml2 resolves |
| Pure Scheme `.scm` modules | ✅ Loaded via entities | ✅ Loaded via entities |

## Why This Format?

1. **DSSSL Tradition**: Uses entity references for modular templates
2. **Steel Context Workaround**: Entity concatenation ensures all definitions are visible
3. **Dual Compatibility**: Works with both OpenJade and Dazzle during transition
4. **Simple Migration**: Only wrapper file changes, `.scm` modules unchanged

## Testing

Verify identical output from both tools:

```bash
# Generate with OpenJade
openjade -t sgml -d grammar.xml scaly.sgm > output-openjade.scaly

# Generate with Dazzle (when available)
dazzle -d grammar.xml scaly.sgm > output-dazzle.scaly

# Compare
diff output-openjade.scaly output-dazzle.scaly
```

Should show no differences.

## File Naming

- **Input document:** `scaly.sgm` (grammar specification)
- **Stylesheet:** `grammar.xml` (code generation template)
- **Output:** `Parser.scaly` (generated by template rules)

The stylesheet is named `grammar.xml` to distinguish it from the input document `scaly.sgm`.
