; testdoc.scm - Generate DocBook documentation from test.dtd documents

(define (generate-testdoc) ($
"&#60;!-- Generated test documentation from tests.sgm --&#62;
&#60;!-- DO NOT EDIT - generated by codegen --&#62;

&#60;section xmlns='http://docbook.org/ns/docbook' xml:id='generated-tests'&#62;
  &#60;title&#62;Test Cases&#60;/title&#62;
"
    (apply-to-selected-children "tests" (lambda (tests) ($
"
  &#60;section xml:id='tests-"(attribute-string "xml:id" tests)"'&#62;
    &#60;title&#62;"(attribute-string "title" tests)"&#60;/title&#62;
    &#60;informaltable&#62;
      &#60;tgroup cols='2'&#62;
        &#60;colspec colwidth='1*'/&#62;
        &#60;colspec colwidth='1*'/&#62;
        &#60;thead&#62;
          &#60;row&#62;
            &#60;entry&#62;Input&#60;/entry&#62;
            &#60;entry&#62;Result&#60;/entry&#62;
          &#60;/row&#62;
        &#60;/thead&#62;
        &#60;tbody&#62;
"
        (apply-to-selected-children-of tests "test" (lambda (test) ($
"          &#60;row&#62;
            &#60;entry&#62;&#60;literal&#62;"(test-input-doc test)"&#60;/literal&#62;&#60;/entry&#62;
            &#60;entry&#62;&#60;literal&#62;"(test-expect-doc test)"&#60;/literal&#62;&#60;/entry&#62;
          &#60;/row&#62;
"
        )))
"        &#60;/tbody&#62;
      &#60;/tgroup&#62;
    &#60;/informaltable&#62;
  &#60;/section&#62;
"
    )))
"
&#60;/section&#62;
"
))

; Get input for documentation (escape XML special chars)
(define (test-input-doc test)
    (escape-xml (trim (data (node-list-first (select-elements (children test) "input"))))))

; Get expect for documentation (escape XML special chars)
(define (test-expect-doc test)
    (escape-xml (trim (data (node-list-first (select-elements (children test) "expect"))))))

; Escape XML special characters
(define (escape-xml s)
    (list->string
        (apply append
            (map (lambda (c)
                    (cond
                        ((char=? c #\&) (string->list "&#38;amp;"))
                        ((char=? c #\<) (string->list "&#38;lt;"))
                        ((char=? c #\>) (string->list "&#38;gt;"))
                        (else (list c))))
                 (string->list s)))))

; trim and drop-leading-ws are defined in testjs.scm
